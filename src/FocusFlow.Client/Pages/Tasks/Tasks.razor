@page "/tasks"
@attribute [Authorize]
@using FocusFlow.Client.Core.Models.Projects
@using Microsoft.AspNetCore.Authorization
@using FocusFlow.Client.Services
@using FocusFlow.Client.Core.Models.ProjectTasks
@using FocusFlow.Client.Core.Models.Enums
@using FocusFlow.Client.Core.Services
@using FocusFlow.Client.Commons.OverlayPanel
@using FocusFlow.Client.Pages.Tasks.Create
@using FocusFlow.Client.Pages.Tasks.Edit
@using FocusFlow.Client.Pages.Tasks.Detail
@inject ProjectTaskClientService ProjectTaskClientService
@inject ProjectClientService ProjectClientService
@inject TaskHubService TaskHubService
@implements IAsyncDisposable

<div class="tasks-container">
    <header class="page-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="page-title">Tasks</h1>
                <p class="page-subtitle">Manage and track your project tasks</p>
            </div>
            <div class="header-actions">
                <button class="btn-primary" type="button" @onclick="OpenCreatePanel">
                    <i class="fa-solid fa-plus"></i>
                    <span>New Task</span>
                </button>
            </div>
        </div>
    </header>

    <div class="filters-section">
        <div class="filter-group">
            <label for="projectFilter">Project</label>
            <select id="projectFilter" class="filter-select" @onchange="OnProjectFilterChanged">
                <option value="">All Projects</option>
                @if (projects != null)
                {
                    foreach (var project in projects)
                    {
                        <option value="@project.Id">@project.Name</option>
                    }
                }
            </select>
        </div>

        <div class="filter-group">
            <label for="statusFilter">Status</label>
            <select id="statusFilter" class="filter-select" @onchange="OnStatusFilterChanged">
                <option value="">All Statuses</option>
                <option value="@ProjectTaskStatus.Todo">To Do</option>
                <option value="@ProjectTaskStatus.InProgress">In Progress</option>
                <option value="@ProjectTaskStatus.Done">Done</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="priorityFilter">Priority</label>
            <select id="priorityFilter" class="filter-select" @onchange="OnPriorityFilterChanged">
                <option value="">All Priorities</option>
                <option value="@ProjectTaskPriority.Low">Low</option>
                <option value="@ProjectTaskPriority.Medium">Medium</option>
                <option value="@ProjectTaskPriority.High">High</option>
                <option value="@ProjectTaskPriority.Critical">Critical</option>
            </select>
        </div>

        @if (selectedProjectId.HasValue || selectedStatus.HasValue || selectedPriority.HasValue)
        {
            <button class="btn-clear-filters" @onclick="ClearFilters">
                <i class="fa-solid fa-times"></i>
                Clear Filters
            </button>
        }
    </div>

    <div class="content-section">
        @if (tasks is null)
        {
            <div class="loading-state">
                <i class="fa-solid fa-spinner fa-spin"></i>
                <span>Loading tasks...</span>
            </div>
        }
        else if (!tasks.Any())
        {
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fa-solid fa-list-check"></i>
                </div>
                <h3>No tasks yet</h3>
                <p>Get started by creating your first task</p>
                <button class="btn-primary" type="button" @onclick="OpenCreatePanel">
                    <i class="fa-solid fa-plus"></i>
                    <span>Create Task</span>
                </button>
            </div>
        }
        else
        {
            <div class="table-container">
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Assigned User</th>
                            <th class="actions-col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var task in tasks)
                        {
                            <tr @onclick="() => OpenDetailPanel(task.Id)" class="table-row">
                                <td class="task-title">@task.Title</td>
                                <td class="task-description">
                                    @if (!string.IsNullOrWhiteSpace(task.Description))
                                    {
                                        <span>@(task.Description.Length > 50 ? task.Description.Substring(0, 50) + "..." : task.Description)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No description</span>
                                    }
                                </td>
                                <td>
                                    @if (task.DueDate.HasValue)
                                    {
                                        <span class="@GetDueDateClass(task.DueDate.Value)">
                                            @task.DueDate.Value.ToString("MMM dd, yyyy")
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>
                                <td>
                                    <span class="status-badge status-@task.Status.ToString().ToLower()">
                                        @GetStatusText(task.Status)
                                    </span>
                                </td>
                                <td>
                                    <span class="priority-badge priority-@task.Priority.ToString().ToLower()">
                                        @task.Priority
                                    </span>
                                </td>
                                <td>
                                    @if (detailedTasks.TryGetValue(task.Id, out var detailedTask))
                                    {
                                        <span>@detailedTask.AssignedToName</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Loading...</span>
                                    }
                                </td>
                                <td class="actions-col" @onclick:stopPropagation="true">
                                    <button class="btn-icon" @onclick="() => OpenEditPanel(task.Id)" title="Edit">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button class="btn-icon btn-icon-danger" @onclick="() => DeleteTask(task.Id)" title="Delete">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@* Create Task Overlay *@
<OverlayPanel IsVisible="showCreatePanel" OnClose="CloseCreatePanel" Title="Create New Task">
    <CreateTask 
        OnTaskCreated="HandleTaskCreated" 
        OnCancel="CloseCreatePanel" />
</OverlayPanel>

@* Edit Task Overlay *@
<OverlayPanel IsVisible="showEditPanel" OnClose="CloseEditPanel" Title="Edit Task">
    @if (selectedTaskId.HasValue)
    {
        <EditTask 
            TaskId="selectedTaskId.Value" 
            OnTaskUpdated="HandleTaskUpdated" 
            OnCancel="CloseEditPanel" />
    }
</OverlayPanel>

@* Task Detail Overlay *@
<OverlayPanel IsVisible="showDetailPanel" OnClose="CloseDetailPanel" Title="Task Details">
    @if (selectedTaskId.HasValue)
    {
        <TaskDetailView 
            TaskId="selectedTaskId.Value" 
            OnEdit="SwitchToEdit"
            OnDelete="HandleTaskDeleted" 
            OnClose="CloseDetailPanel" />
    }
</OverlayPanel>

@code {
    private List<ProjectTaskSimpleDto>? tasks;
    private List<ProjectLookupDto>? projects;
    private Dictionary<long, ProjectTaskDetailDto> detailedTasks = new();
    private bool showCreatePanel = false;
    private bool showEditPanel = false;
    private bool showDetailPanel = false;
    private long? selectedTaskId;
    private long? selectedProjectId;
    private ProjectTaskStatus? selectedStatus;
    private ProjectTaskPriority? selectedPriority;

    protected override async Task OnInitializedAsync()
    {
        projects = await ProjectClientService.GetLookup();
        await LoadTasks();
        
        // Subscribe to SignalR events
        TaskHubService.TaskCreated += OnTaskCreatedFromHub;
        TaskHubService.TaskUpdated += OnTaskUpdatedFromHub;
        TaskHubService.TaskDeleted += OnTaskDeletedFromHub;
        
        // Start SignalR connection
        await TaskHubService.StartAsync();
    }

    private async Task OnTaskCreatedFromHub(long taskId)
    {
        await LoadTasks();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnTaskUpdatedFromHub(long taskId)
    {
        await LoadTasks();
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnTaskDeletedFromHub(long taskId)
    {
        await LoadTasks();
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        // Unsubscribe from SignalR events
        TaskHubService.TaskCreated -= OnTaskCreatedFromHub;
        TaskHubService.TaskUpdated -= OnTaskUpdatedFromHub;
        TaskHubService.TaskDeleted -= OnTaskDeletedFromHub;
    }

    private async Task LoadTasks()
    {
        tasks = await ProjectTaskClientService.GetAll(selectedProjectId, selectedStatus, selectedPriority);
        
        // Load detailed info for assigned users
        if (tasks != null)
        {
            detailedTasks.Clear();
            foreach (var task in tasks)
            {
                var detailedTask = await ProjectTaskClientService.GetById(task.Id);
                if (detailedTask != null)
                {
                    detailedTasks[task.Id] = detailedTask;
                }
            }
            StateHasChanged();
        }
    }

    private async Task OnProjectFilterChanged(ChangeEventArgs e)
    {
        selectedProjectId = long.TryParse(e.Value?.ToString(), out var id) ? id : null;
        await LoadTasks();
    }

    private async Task OnStatusFilterChanged(ChangeEventArgs e)
    {
        selectedStatus = Enum.TryParse<ProjectTaskStatus>(e.Value?.ToString(), out var status) ? status : null;
        await LoadTasks();
    }

    private async Task OnPriorityFilterChanged(ChangeEventArgs e)
    {
        selectedPriority = Enum.TryParse<ProjectTaskPriority>(e.Value?.ToString(), out var priority) ? priority : null;
        await LoadTasks();
    }

    private async Task ClearFilters()
    {
        selectedProjectId = null;
        selectedStatus = null;
        selectedPriority = null;
        await LoadTasks();
    }

    private void OpenCreatePanel()
    {
        showCreatePanel = true;
    }

    private void CloseCreatePanel()
    {
        showCreatePanel = false;
    }

    private async Task HandleTaskCreated(ProjectTaskDetailDto task)
    {
        CloseCreatePanel();
        await LoadTasks();
    }

    private void OpenEditPanel(long taskId)
    {
        selectedTaskId = taskId;
        showEditPanel = true;
    }

    private void CloseEditPanel()
    {
        showEditPanel = false;
        selectedTaskId = null;
    }

    private async Task HandleTaskUpdated(ProjectTaskDetailDto task)
    {
        CloseEditPanel();
        await LoadTasks();
    }

    private void OpenDetailPanel(long taskId)
    {
        selectedTaskId = taskId;
        showDetailPanel = true;
    }

    private void CloseDetailPanel()
    {
        showDetailPanel = false;
        selectedTaskId = null;
    }

    private void SwitchToEdit()
    {
        showDetailPanel = false;
        showEditPanel = true;
    }

    private async Task HandleTaskDeleted()
    {
        CloseDetailPanel();
        await LoadTasks();
    }

    private async Task DeleteTask(long taskId)
    {
        // Simple confirmation - in production, use a proper modal
        var success = await ProjectTaskClientService.DeleteAsync(taskId);
        if (success)
        {
            await LoadTasks();
        }
    }

    private string GetStatusText(ProjectTaskStatus status)
    {
        return status switch
        {
            ProjectTaskStatus.Todo => "To Do",
            ProjectTaskStatus.InProgress => "In Progress",
            ProjectTaskStatus.Done => "Done",
            _ => status.ToString()
        };
    }

    private string GetDueDateClass(DateTime dueDate)
    {
        var daysUntilDue = (dueDate.Date - DateTime.UtcNow.Date).Days;
        
        if (daysUntilDue < 0)
            return "due-overdue";
        else if (daysUntilDue <= 3)
            return "due-soon";
        else
            return "due-normal";
    }
}
